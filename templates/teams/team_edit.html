{% extends 'base.html' %}
{% block content %}
<style>
  .edit-wrap{max-width:920px;margin:28px auto;padding:20px;border-radius:14px;background:var(--card);box-shadow:var(--shadow-sm)}
  .form-grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
  @media (max-width:920px){ .form-grid{grid-template-columns:1fr} }
  .form-helpers{font-size:13px;color:var(--muted);margin-top:8px}
  .actions{display:flex;gap:10px;margin-top:14px}
  label{display:block;margin-top:12px;font-weight:700}
  input[type="text"], input[type="file"], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);box-sizing:border-box}
  /* Dual listbox */
  .dual{display:grid;grid-template-columns:1fr 64px 1fr;gap:12px;align-items:center}
  .listbox{border:1px solid rgba(15,23,42,0.06);border-radius:10px;padding:8px;min-height:220px;overflow:auto}
  .listbox button{display:block;width:100%;padding:6px 10px;margin-bottom:6px}
  .ctrls{display:flex;flex-direction:column;gap:8px;align-items:center}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
</style>

<div class="edit-wrap">
  <h2 style="margin-top:0">Edit Team — {{ team.name }}</h2>

  <form method="post" enctype="multipart/form-data" novalidate id="team-form">
    {% csrf_token %}
    <div class="form-grid">
      <div>
        <label for="id_name">Team name</label>
        {{ form.name }}

        <label for="id_short_name">Short name</label>
        {{ form.short_name }}

        <label for="id_logo">Logo</label>
        {{ form.logo }}

        <div class="form-helpers">Tip: upload a square logo (min 300x300) for best results.</div>
      </div>

      <aside>
        <label for="id_players">Players</label>
        <div class="form-helpers">Use the controls to add or remove players from this team. Works with keyboard and screen readers.</div>

        {# Keep the original select for progressive enhancement but hide it visually. JS will sync with it. #}
        <div class="sr-only" aria-hidden="false">
          {{ form.players }}
        </div>

        <div class="dual" aria-hidden="false">
          <div>
            <div class="listbox" id="available" aria-label="Available players" tabindex="0"></div>
          </div>

          <div class="ctrls" aria-hidden="false">
            <button type="button" class="btn" id="add">Add →</button>
            <button type="button" class="btn ghost" id="remove">← Remove</button>
          </div>

          <div>
            <div class="listbox" id="selected" aria-label="Selected players" tabindex="0"></div>
          </div>
        </div>

        <div class="form-helpers" style="margin-top:10px">Selected players will be included in the team. Save to persist changes.</div>
      </aside>
    </div>

    <div class="actions">
      <button class="btn" type="submit">Save changes</button>
      <a class="btn ghost" href="{% url 'accounts:team_detail' team.pk %}">Cancel</a>
    </div>
  </form>

  <script>
    // Dual-listbox behavior — syncs with the original select (name=id_players)
    (function(){
      const original = document.getElementById('id_players');
      if(!original) return; // progressive enhancement safe

      const available = document.getElementById('available');
      const selected = document.getElementById('selected');
      const addBtn = document.getElementById('add');
      const removeBtn = document.getElementById('remove');

      // build lists from options
      function render(){
        available.innerHTML = '';
        selected.innerHTML = '';
        Array.from(original.options).forEach(opt => {
          const el = document.createElement('div');
          el.setAttribute('data-val', opt.value);
          el.tabIndex = 0;
          el.className = 'item';
          el.style.padding = '8px 6px';
          el.style.borderRadius = '8px';
          el.style.cursor = 'pointer';
          el.style.marginBottom = '6px';
          el.textContent = opt.text;
          if(opt.selected){ selected.appendChild(el); }
          else { available.appendChild(el); }
        });
      }

      function pick(container){
        const items = Array.from(container.querySelectorAll('[data-val]'));
        return items.filter(i => i.classList.contains('picked'));
      }

      // simple selection handling (click or keyboard)
      [available, selected].forEach(list => {
        list.addEventListener('click', e => {
          const it = e.target.closest('[data-val]'); if(!it) return;
          // toggle picked
          it.classList.toggle('picked');
          it.style.background = it.classList.contains('picked') ? 'rgba(43,109,246,0.06)' : 'transparent';
        });
        list.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); e.target.click(); }
        });
      });

      addBtn.addEventListener('click', () => {
        const picks = pick(available);
        picks.forEach(p => selected.appendChild(p));
        sync();
      });
      removeBtn.addEventListener('click', () => {
        const picks = pick(selected);
        picks.forEach(p => available.appendChild(p));
        sync();
      });

      function sync(){
        // clear original selected
        Array.from(original.options).forEach(o => o.selected = false);
        Array.from(selected.querySelectorAll('[data-val]')).forEach(node => {
          const val = node.getAttribute('data-val');
          const opt = original.querySelector('option[value="'+val+'"]');
          if(opt) opt.selected = true;
          node.classList.remove('picked'); node.style.background = 'transparent';
        });
        Array.from(available.querySelectorAll('[data-val]')).forEach(node => { node.classList.remove('picked'); node.style.background = 'transparent'; });
      }

      // initialize
      render();

      // ensure sync before submit
      document.getElementById('team-form').addEventListener('submit', function(){ sync(); });
    })();
  </script>
</div>

{% endblock %}
